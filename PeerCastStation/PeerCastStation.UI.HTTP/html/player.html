<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>再生</title>
    <script type="text/javascript" src="/Scripts/es5-shim.min.js"></script>
    <script type="text/javascript" src="/Scripts/es6-shim.min.js"></script>
    <script type="text/javascript" src="/api/1/peercaststation.js"></script>
    <link href="https://vjs.zencdn.net/7.20.2/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/7.20.2/video.min.js"></script>
    <style>
  #player {
    position: absolute;
    width: 100%;
    height: 100%;
    left: 0;
    top: 0;
  }
    </style>
  </head>
  <body>
    <video id="player" class="video-js" controls width="960" height="540">
    </video>
    <script type="text/javascript">
      window.addEventListener('load', function () {
        var params = (new URL(document.location)).searchParams;
        var channelId = params.get('channelId');
        var tracker = params.get('tip');
        var player = videojs('player', {
          liveui: true, 
          autoplay: true,
          userActions: { click: false },
          html5: {
            vhs: {
              maxPlaylistRetries: 5,
              blacklistDuration: Infinity
            }
          }
        });
        var lastVolume = parseFloat(window.localStorage.getItem('player.volume'))
        player.volume(isNaN(lastVolume) ? 0.5 : lastVolume)
        player.el().addEventListener('wheel', function (evt) {
          if (evt.deltaY!==0.0) {
            var dy = (evt.deltaY < 0.0 ? 1.0 : -1.0) * 0.10;
            if (dy > 0.0 && player.muted()) {
              player.volume(dy);
              player.muted(false);
            }
            else {
              player.volume(player.volume() + dy);
            }
            player.userActive(true);
            player.getChild('ControlBar').getChild('VolumePanel').addClass('vjs-hover');
          }
        });
        player.on('volumechange', function (evt) {
          try {
            window.localStorage.setItem('player.volume', player.volume().toString());
          }
          catch {
          }
        });
        player.on('loadedmetadata', function (evt) {
          PeerCastStation.getChannelInfo(channelId).then(function (result) {
            if (result.info && result.info.name) {
              document.title = result.info.name;
            }
          }).catch(function () {
          });
        });
        var onPlayerError = function (retry) {
          PeerCastStation.getChannelStatus(channelId).then(function (result) {
            switch (result.status) {
            case "Idle":
                player.getChild("errorDisplay").fillWith('チャンネルが終了しました');
                break;
            case "Receiving":
                player.reset();
                if (tracker) {
                  player.src({type: 'video/mpegURL', src: '/hls/' + channelId + '.m3u8?tip=' + tracker});
                }
                else {
                  player.src({type: 'video/mpegURL', src: '/hls/' + channelId + '.m3u8'});
                }
                break;
            case "Searching":
            case "Connecting":
                player.getChild("errorDisplay").fillWith('チャンネル再接続中');
                window.setTimeout(function () { onPlayerError(retry); }, 1.0);
                break;
            case "Error":
                if (retry) {
                  player.getChild("errorDisplay").fillWith('チャンネルに接続できません');
                  PeerCastStation.bumpChannel(channelId).then(function () {
                    window.setTimeout(function () { onPlayerError(retry); }, 1.0);
                  }).catch(function () {
                  });
                }
                break;
            }
          }).catch(function () {
            player.getChild("errorDisplay").fillWith('チャンネルが切断されました');
          });
        }
        player.on('error', function (evt) {
          console.log('Player error', evt)
          onPlayerError(true);
        });
        player.on('stalled', function (evt) {
          console.log('Player stalled', evt)
        });
        player.on('ended', function (evt) {
          console.log('Player ended', evt)
          onPlayerError(true);
        });
        player.on('abort', function (evt) {
          console.log('Player abort', evt)
          onPlayerError(true);
        });
        player.on('emptied', function (evt) {
          console.log('Player emptied', evt)
        });
        if (channelId) {
          if (tracker) {
            player.src({type: 'video/mpegURL', src: '/hls/' + channelId + '.m3u8?tip=' + tracker});
          }
          else {
            player.src({type: 'video/mpegURL', src: '/hls/' + channelId + '.m3u8'});
          }
        }
      });
    </script>
  </body>
</html>
